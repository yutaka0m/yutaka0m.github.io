<!doctype html><html lang=jp-ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=hugo-theme content="Axiom 0.7.0"><link rel=icon href=https://resources.yutaka0m.com/favicon.ico><link rel=apple-touch-icon href=/image/brand/icon-1-1.jpg><link rel=canonical href=https://tech.yutaka0m.com/entry/2020/04/09/221/><link rel=preload as=style href="/bundle.css?v=1613305652" media=all><link rel=stylesheet href="/bundle.css?v=1613305652" media=all><style>.cdata pre{color:#edf2f7;background-color:#2d3748}.cdata :not(pre)>code{color:#805ad5;background-color:#f7fafc}.chroma .err{color:#fed7d7;background-color:#9b2c2c}.chroma .hl{background-color:#4a5568}.chroma .ln{color:#a0aec0}.chroma .k,.chroma .kc,.chroma .kd,.chroma .kn,.chroma .kp,.chroma .kr{color:#63b3ed}.chroma .kt{color:#b794f4}.chroma .na{color:#f6e05e}.chroma .nb{color:#f6ad55}.chroma .nc{color:#fc8181}.chroma .no{color:#68d391}.chroma .nd{color:#fc8181}.chroma .ne{color:#fc8181}.chroma .nf{color:#f6ad55}.chroma .nt{color:#fc8181}.chroma .l{color:#b794f4}.chroma .dl,.chroma .ld,.chroma .s,.chroma .s2,.chroma .sa,.chroma .sb,.chroma .sc,.chroma .sd{color:#68d391}.chroma .se{color:#a0aec0}.chroma .s1,.chroma .sh,.chroma .si,.chroma .sr,.chroma .ss,.chroma .sx{color:#68d391}.chroma .il,.chroma .m,.chroma .mb,.chroma .mf,.chroma .mh,.chroma .mi,.chroma .mo{color:#b794f4}.chroma .o,.chroma .ow{color:#90cdf4}.chroma .p{color:#cbd5e0}.chroma .c,.chroma .c1,.chroma .ch,.chroma .cm,.chroma .cp,.chroma .cpf,.chroma .cs{color:#a0aec0}.chroma .ge{font-style:italic}.chroma .gs{font-weight:700}</style><title>Terraform / AWS ALBにCognito認証をかける : yutaka0m blog</title><meta property="og:title" content="Terraform / AWS ALBにCognito認証をかける"><meta property="og:site_name" content="yutaka0m blog"><meta property="og:url" content="https://tech.yutaka0m.com/entry/2020/04/09/221/"><link rel=image_src href=https://tech.yutaka0m.com/image/top-image.jpg><meta property="og:image" content="https://tech.yutaka0m.com/image/top-image.jpg"><meta property="og:image:width" content="1920"><meta property="og:image:height" content="1080"><meta property="og:type" content="article"><meta property="og:locale" content="jp_ja"><meta property="og:description" content="Amazon Cognito ユーザープールとAWS Application Load Balancerをつかて、簡単に自分のWebページに認証けることができます。 他によい例が見あたらなかったので、Terraformを使って実装するサンプルを作成しました。 サンプルの構成 ALBにてCognito認証をかけ、認証に成功したら固定レスポンスを返します。 準備 事前に次のものを用意しておく必要があります。  Route 53で管理されたホストゾーン AWS Certificate Manager(ACM)で作成したSSL証明書  Terraformサンプルコード 設定 設定情報です。 NOTE:と書いてある項目は、自分の環境のものに変換する必要があります。 variables.tf locals { name = &amp;quot;cognito-test&amp;quot; tags = { &amp;quot;Name&amp;quot; = local.name } ################### # VPC ################### cidr = &amp;quot;"><meta name=description content="Amazon Cognito ユーザープールとAWS Application Load Balancerをつかて、簡単に自分のWebページに認証けることができます。 他によい例が見あたらなかったので、Terraformを使って実装するサンプルを作成しました。 サンプルの構成 ALBにてCognito認証をかけ、認証に成功したら固定レスポンスを返します。 準備 事前に次のものを用意しておく必要があります。  Route 53で管理されたホストゾーン AWS Certificate Manager(ACM)で作成したSSL証明書  Terraformサンプルコード 設定 設定情報です。 NOTE:と書いてある項目は、自分の環境のものに変換する必要があります。 variables.tf locals { name = &amp;quot;cognito-test&amp;quot; tags = { &amp;quot;Name&amp;quot; = local.name } ################### # VPC ################### cidr = &amp;quot;"><meta property="og:updated_time" content="2020-04-09T07:42:48Z"><meta property="fb:app_id" content><meta name=author content="yutaka0m"><meta property="article:author" content="https://tech.yutaka0m.com"><meta property="article:published_time" content="2020-04-09T07:42:48Z"><meta property="article:modified_time" content="2020-04-09T07:42:48Z"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Terraform / AWS ALBにCognito認証をかける","alternativeHeadline":"Amazon Cognito ユーザープールとAWS Application Load Balancerをつかて、簡単に自分のWebページに認証けることができます。 他によい例が見あたらなかったので、Terraformを使って実装するサンプルを作成しました。 サンプルの構成 ALBにてCognito認証をかけ、認証に成功したら固定レスポンスを返します。 準備 事前に次のものを用意しておく必要があります。  Route 53で管理されたホストゾーン AWS Certificate Manager(ACM)で作成したSSL証明書  Terraformサンプルコード 設定 設定情報です。 NOTE:と書いてある項目は、自分の環境のものに変換する必要があります。 variables.tf locals { name = \u0026quot;cognito-test\u0026quot; tags = { \u0026quot;Name\u0026quot; = local.name } ################### # VPC ################### cidr = \u0026quot;","url":"https://tech.yutaka0m.com/entry/2020/04/09/221/","image":"https://tech.yutaka0m.com/image/top-image.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://tech.yutaka0m.com/entry/2020/04/09/221/"},"description":"Amazon Cognito ユーザープールとAWS Application Load Balancerをつかて、簡単に自分のWebページに認証けることができます。 他によい例が見あたらなかったので、Terraformを使って実装するサンプルを作成しました。 サンプルの構成 ALBにてCognito認証をかけ、認証に成功したら固定レスポンスを返します。 準備 事前に次のものを用意しておく必要があります。  Route 53で管理されたホストゾーン AWS Certificate Manager(ACM)で作成したSSL証明書  Terraformサンプルコード 設定 設定情報です。 NOTE:と書いてある項目は、自分の環境のものに変換する必要があります。 variables.tf locals { name = \u0026quot;cognito-test\u0026quot; tags = { \u0026quot;Name\u0026quot; = local.name } ################### # VPC ################### cidr = \u0026quot;","author":{"@type":"Person","name":"yutaka0m"},"publisher":{"@type":"Organization","name":"yutaka0m blog","logo":{"@type":"ImageObject","url":"https://tech.yutaka0m.com/image/brand/icon-1-1.jpg"}},"datePublished":"2020-04-09T07:42:48Z","dateModified":"2020-04-09T07:42:48Z","articleBody":"\u003cp\u003eAmazon Cognito ユーザープールとAWS Application Load Balancerをつかて、簡単に自分のWebページに認証けることができます。\u003c/p\u003e\u003c/p\u003e\n\u003cp\u003e他によい例が見あたらなかったので、Terraformを使って実装するサンプルを作成しました。\u003c/p\u003e\n\u003ch2 id=\"サンプルの構成\"\u003eサンプルの構成\u003c/h2\u003e\n\u003cp\u003eALBにてCognito認証をかけ、認証に成功したら固定レスポンスを返します。\u003c/p\u003e\n\u003ch2 id=\"準備\"\u003e準備\u003c/h2\u003e\n\u003cp\u003e事前に次のものを用意しておく必要があります。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eRoute 53で管理されたホストゾーン\u003c/li\u003e\n\u003cli\u003eAWS Certificate Manager(ACM)で作成したSSL証明書\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"terraformサンプルコード\"\u003eTerraformサンプルコード\u003c/h2\u003e\n\u003ch3 id=\"設定\"\u003e設定\u003c/h3\u003e\n\u003cp\u003e設定情報です。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eNOTE:\u003c/code\u003eと書いてある項目は、自分の環境のものに変換する必要があります。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003evariables.tf\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-json\"\u003elocals {\n  name = \"cognito-test\"\n  tags = {\n    \"Name\" = local.name\n  }\n  ###################\n  # VPC\n  ###################\n  cidr            = \"10.20.0.0/16\"\n  azs             = [\"ap-northeast-1a\", \"ap-northeast-1c\"]\n  private_subnets = [\"10.20.1.0/24\", \"10.20.2.0/24\"]\n  public_subnets  = [\"10.20.101.0/24\", \"10.20.102.0/24\"]\n  ###################\n  # ALB\n  ###################\n  # NOTE: ACMのARN\n  certificate_arn = \"arn:aws:acm:ap-northeast-1:000000000000:certificate/xxxxxx\"\n  backend_port    = 80\n  ###################\n  # Security groups\n  ###################\n  # 通過させるCIDRを設定(可能なら絞ったほうがよい)\n  alb_ingress_cidr_blocks = [\n    \"0.0.0.0/0\"\n  ]\n  ###################\n  # Route 53\n  ###################\n  domain_name = \"example.com\" #NOTE: Route53で管理しているドメイン名\n  ###################\n  # Cognito\n  ###################\n  # https://${cognito_oauth_domain_name}.auth.ap-northeast-1.amazoncognito.com というドメインを取得してくれる\n  cognito_oauth_domain_name = \"cognito-oauth\" #NOTE: Cognito認証のドメイン名(任意の名前)\n}\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eまた、プロバイダの設定なども記述します。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003econfiguration.tf\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-json\"\u003eprovider \"aws\" {\n  region  = \"ap-northeast-1\"\n  version = \"~\u0026gt; 2.0\"\n}\nterraform {\n  required_version = \"~\u0026gt; 0.12\"\n}\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"cognito\"\u003eCognito\u003c/h3\u003e\n\u003cp\u003eAWSの開発者ガイド\u003ca href=\"https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/getting-started-with-cognito-user-pools.html\"\u003eユーザープールの開始方法\u003c/a\u003eを参考にして、Cognitoユーザープールの設定を記述しています。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-json\"\u003eresource \"aws_cognito_user_pool\" \"this\" {\n  name                = \"tools-user-pool\"\n  mfa_configuration   = \"OFF\"     # MFA認証はしない\n  username_attributes = [\"email\"] # emailでログインする\n  admin_create_user_config {\n    allow_admin_create_user_only = true # 管理者のみがログインユーザを作成できる\n  }\n  password_policy {\n    # デフォルト値\n    minimum_length    = 8\n    require_lowercase = true\n    require_numbers   = true\n    require_symbols   = true\n    require_uppercase = true\n    temporary_password_validity_days = 3 # 一時パスワードの有効期限\n  }\n}\nresource \"aws_cognito_user_pool_client\" \"this\" {\n  name                          = \"tools\"\n  user_pool_id                  = aws_cognito_user_pool.this.id\n  prevent_user_existence_errors = \"ENABLED\" # LEGACY or ENABLED (AWSの推奨はENABLED)\n  generate_secret               = true      # アプリケーションシークレットの生成\n  # アプリクライアントの設定\n  supported_identity_providers         = [\"COGNITO\"]\n  callback_urls                        = [\"https://${local.name}.${local.domain_name}/oauth2/idpresponse\"]\n  allowed_oauth_flows                  = [\"code\"]\n  allowed_oauth_flows_user_pool_client = true\n  allowed_oauth_scopes = [\n    \"openid\"\n  ]\n  explicit_auth_flows = [\n    \"ALLOW_CUSTOM_AUTH\",\n    \"ALLOW_REFRESH_TOKEN_AUTH\",\n    \"ALLOW_USER_SRP_AUTH\",\n  ]\n}\nresource \"aws_cognito_user_pool_domain\" \"this\" {\n  domain       = local.cognito_oauth_domain_name\n  user_pool_id = aws_cognito_user_pool.this.id\n}\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"ネットワーク\"\u003eネットワーク\u003c/h3\u003e\n\u003cp\u003eネットワークの設定は、\u003ccode\u003eterraform-aws-modules/vpc/aws\u003c/code\u003eを使って設定しています。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003enetwork.tf\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-json\"\u003emodule \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  version = \"2.33.0\"\n  create_vpc = true\n  name = local.name\n  cidr            = local.cidr\n  azs             = local.azs\n  private_subnets = local.private_subnets\n  public_subnets  = local.public_subnets\n  enable_nat_gateway = true\n  single_nat_gateway = true\n  tags = local.tags\n}\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"ロードバランサー\"\u003eロードバランサー\u003c/h3\u003e\n\u003cp\u003eApplication Load Balancerの設定です。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eHTTPのリダイレクト設定\u003c/li\u003e\n\u003cli\u003eCognito認証通したら固定レスポンスを返す\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eなどの設定をしています。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eload-balancer.tf\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-json\"\u003emodule \"alb\" {\n  source  = \"terraform-aws-modules/alb/aws\"\n  version = \"5.3.0\"\n  name = local.name\n  vpc_id          = module.vpc.vpc_id\n  subnets         = module.vpc.public_subnets\n  security_groups = flatten([module.alb_https_sg.this_security_group_id, module.alb_http_sg.this_security_group_id])\n  access_logs = {}\n  https_listeners = [\n    {\n      port            = 443\n      certificate_arn = local.certificate_arn\n    },\n  ]\n  http_tcp_listeners = [\n    {\n      port     = 80\n      protocol = \"HTTP\"\n    },\n  ]\n  target_groups = [\n    {\n      name                 = local.name\n      backend_protocol     = \"HTTP\"\n      backend_port         = local.backend_port\n      target_type          = \"ip\"\n      deregistration_delay = 10\n    },\n  ]\n  tags = local.tags\n}\nresource \"aws_alb_listener_rule\" \"haribote_response\" {\n  listener_arn = module.alb.https_listener_arns[0]\n  action {\n    order = 1\n    type  = \"authenticate-cognito\"\n    authenticate_cognito {\n      user_pool_arn       = aws_cognito_user_pool.this.arn\n      user_pool_client_id = aws_cognito_user_pool_client.this.id\n      user_pool_domain    = aws_cognito_user_pool_domain.this.domain\n    }\n  }\n  action {\n    order = 2\n    type  = \"fixed-response\"\n    fixed_response {\n      content_type = \"text/html\"\n      message_body = \"\u0026lt;h1\u0026gt;Success\u0026lt;/h1\u0026gt;\"\n      status_code  = \"200\"\n    }\n  }\n  condition {\n    field  = \"path-pattern\"\n    values = [\"*\"]\n  }\n}\nresource \"aws_lb_listener_rule\" \"redirect_http_to_https\" {\n  listener_arn = module.alb.http_tcp_listener_arns[0]\n  action {\n    type = \"redirect\"\n    redirect {\n      port        = \"443\"\n      protocol    = \"HTTPS\"\n      status_code = \"HTTP_301\"\n    }\n  }\n  condition {\n    field  = \"path-pattern\"\n    values = [\"*\"]\n  }\n}\n###################\n# Security groups\n###################\nmodule \"alb_https_sg\" {\n  source  = \"terraform-aws-modules/security-group/aws//modules/https-443\"\n  version = \"v3.0.1\"\n  name        = \"${local.name}-alb-https\"\n  vpc_id      = module.vpc.vpc_id\n  ingress_cidr_blocks = local.alb_ingress_cidr_blocks\n  tags = local.tags\n}\nmodule \"alb_http_sg\" {\n  source  = \"terraform-aws-modules/security-group/aws//modules/http-80\"\n  version = \"v3.0.1\"\n  name        = \"${local.name}-alb-http\"\n  vpc_id      = module.vpc.vpc_id\n  ingress_cidr_blocks = local.alb_ingress_cidr_blocks\n  tags = local.tags\n}\n###################\n# Route53 record\n###################\ndata \"aws_route53_zone\" \"this\" {\n  name         = local.domain_name\n  private_zone = false\n}\nresource \"aws_route53_record\" \"this\" {\n  zone_id = data.aws_route53_zone.this.zone_id\n  name    = local.name\n  type    = \"A\"\n  alias {\n    name                   = module.alb.this_lb_dns_name\n    zone_id                = module.alb.this_lb_zone_id\n    evaluate_target_health = true\n  }\n}\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"実行\"\u003e実行\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eterraform apply\u003c/code\u003eすれば、各種リソースが作成されます。\u003c/p\u003e\n\u003ch3 id=\"ユーザーの作成\"\u003eユーザーの作成\u003c/h3\u003e\n\u003cp\u003e認証に使用するユーザーを登録します。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://ap-northeast-1.console.aws.amazon.com/cognito/users/?region=ap-northeast-1#/\"\u003eユーザープール コンソール\u003c/a\u003e にアクセス\n\u003cul\u003e\n\u003cli\u003eTerraformで作成されたユーザープールを選択\u003c/li\u003e\n\u003cli\u003e左のリストから\u003ccode\u003eユーザーとプール\u003c/code\u003eを選択\u003c/li\u003e\n\u003cli\u003eユーザーの作成\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"検証\"\u003e検証\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003ehttps://cognito-test.example.com\u003c/code\u003eにアクセスすると、認証画面が表示されます。( *\u003ccode\u003eexample.com\u003c/code\u003eは自分のドメインに置換してください )\u003c/p\u003e\n\u003cp\u003e認証に成功して、\u003ccode\u003eSuccess\u003c/code\u003eという表示が出れば成功です。\u003c/p\u003e\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\u003cp\u003eTerraformを使って、AWS ALBにCognito認証をかけるサンプルコードでした。\u003c/p\u003e"}</script><link rel=preload as=script href="/bundle.js?v=1613305652"></head><body><header id=nav class=header><div class="ax-l-i max-w-6xl"><div class=ax-logo><a class=block href=/ title="yutaka0m blog"><span class="font-semibold text-raven-900">yutaka0m blog</span></a></div><div class=ax-user><a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target=_blank rel="noopener nofollow" href="https://www.google.com/search?q=site:https://tech.yutaka0m.com" title=Search><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33.0 002.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg></a><a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href=/entry/>記事一覧</a></div></div></header><main><div class=default-single><div class="ax-title ax-l-o"><div class="ax-l-i max-w-680"><h1 class="post-title font-content-title font-normal leading-tight tracking-default text-40">Terraform / AWS ALBにCognito認証をかける</h1><div class="ax-meta flex items-center mt-5"><div class="flex-grow min-w-0"><div class="flex items-center"><div class=flex-shrink-0><img class="w-12 h-12 sm:w-14 sm:h-14 object-cover p-3px rounded-full border border-blue-300" src=/image/author/default.jpg alt=yutaka0m></div><div class="flex-shrink-0 ml-2 leading-tight font-content-sans"><a class="block text-sm text-raven-800 hover:text-raven-900 hover:underline focus:underline" target=_blank rel="noopener nofollow" title=yutaka0m href=https://tech.yutaka0m.com>yutaka0m</a>
<time class="text-sm text-raven-500" datetime=2020-04-09T07:42:48Z>Apr 9, 2020 7:42AM</time></div></div></div><div><div class="flex items-center"><a class="flex-shrink-0 block text-raven-800 hover:text-raven-900" target=_blank rel="noopener nofollow" title="Share on Twitter" href="https://twitter.com/intent/tweet?text=Terraform%20%2f%20AWS%20ALB%e3%81%abCognito%e8%aa%8d%e8%a8%bc%e3%82%92%e3%81%8b%e3%81%91%e3%82%8b%20by%20%40yutaka0m%20https%3a%2f%2ftech.yutaka0m.com%2fentry%2f2020%2f04%2f09%2f221%2f"><svg class="w-6 h-6 fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11.0 01-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56.0 00-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57.0 002.914 5.452 6.48 6.48.0 01-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42.0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18.0 01-8.134 2.798c-.538.0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072.0 18.672-10 18.672-18.668.0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a><a class="ml-3 flex-shrink-0 block text-raven-800 hover:text-raven-900" target=_blank rel="noopener nofollow" title="Share on Facebook" href="https://www.facebook.com/dialog/share?app_id=&display=page&href=https%3a%2f%2ftech.yutaka0m.com%2fentry%2f2020%2f04%2f09%2f221%2f"><svg class="w-6 h-6 fill-current" viewBox="-7 -3.5 39 39" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.234.0H1.765C.8.001.0.79.0 1.766v28.47C.001 31.2.79 32 1.766 32h15.328V19.625h-4.156V14.78h4.156v-3.564c0-4.134 2.523-6.384 6.21-6.384 1.766.0 3.284.13 3.726.2v4.32h-2.543c-2.006.0-2.394.953-2.394 2.352v3.085h4.797l-.625 4.844h-4.172V32h8.14C31.21 32 32 31.2 32 30.234V1.765C32 .8 31.21.0 30.234.0z"/></svg></a></div></div></div></div></div><div class="ax-content ax-l-o"><div class="ax-l-i max-w-680"><article class=cdata><p>Amazon Cognito ユーザープールとAWS Application Load Balancerをつかて、簡単に自分のWebページに認証けることができます。</p></p><p>他によい例が見あたらなかったので、Terraformを使って実装するサンプルを作成しました。</p><h2 id=サンプルの構成>サンプルの構成</h2><p>ALBにてCognito認証をかけ、認証に成功したら固定レスポンスを返します。</p><h2 id=準備>準備</h2><p>事前に次のものを用意しておく必要があります。</p><ul><li>Route 53で管理されたホストゾーン</li><li>AWS Certificate Manager(ACM)で作成したSSL証明書</li></ul><h2 id=terraformサンプルコード>Terraformサンプルコード</h2><h3 id=設定>設定</h3><p>設定情報です。</p><p><code>NOTE:</code>と書いてある項目は、自分の環境のものに変換する必要があります。</p><p><code>variables.tf</code></p><pre><code class=language-json>locals {
  name = "cognito-test"
  tags = {
    "Name" = local.name
  }
  ###################
  # VPC
  ###################
  cidr            = "10.20.0.0/16"
  azs             = ["ap-northeast-1a", "ap-northeast-1c"]
  private_subnets = ["10.20.1.0/24", "10.20.2.0/24"]
  public_subnets  = ["10.20.101.0/24", "10.20.102.0/24"]
  ###################
  # ALB
  ###################
  # NOTE: ACMのARN
  certificate_arn = "arn:aws:acm:ap-northeast-1:000000000000:certificate/xxxxxx"
  backend_port    = 80
  ###################
  # Security groups
  ###################
  # 通過させるCIDRを設定(可能なら絞ったほうがよい)
  alb_ingress_cidr_blocks = [
    "0.0.0.0/0"
  ]
  ###################
  # Route 53
  ###################
  domain_name = "example.com" #NOTE: Route53で管理しているドメイン名
  ###################
  # Cognito
  ###################
  # https://${cognito_oauth_domain_name}.auth.ap-northeast-1.amazoncognito.com というドメインを取得してくれる
  cognito_oauth_domain_name = "cognito-oauth" #NOTE: Cognito認証のドメイン名(任意の名前)
}</code></pre><p>また、プロバイダの設定なども記述します。</p><p><code>configuration.tf</code></p><pre><code class=language-json>provider "aws" {
  region  = "ap-northeast-1"
  version = "~&gt; 2.0"
}
terraform {
  required_version = "~&gt; 0.12"
}</code></pre><h3 id=cognito>Cognito</h3><p>AWSの開発者ガイド<a href=https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/getting-started-with-cognito-user-pools.html>ユーザープールの開始方法</a>を参考にして、Cognitoユーザープールの設定を記述しています。</p><pre><code class=language-json>resource "aws_cognito_user_pool" "this" {
  name                = "tools-user-pool"
  mfa_configuration   = "OFF"     # MFA認証はしない
  username_attributes = ["email"] # emailでログインする
  admin_create_user_config {
    allow_admin_create_user_only = true # 管理者のみがログインユーザを作成できる
  }
  password_policy {
    # デフォルト値
    minimum_length    = 8
    require_lowercase = true
    require_numbers   = true
    require_symbols   = true
    require_uppercase = true
    temporary_password_validity_days = 3 # 一時パスワードの有効期限
  }
}
resource "aws_cognito_user_pool_client" "this" {
  name                          = "tools"
  user_pool_id                  = aws_cognito_user_pool.this.id
  prevent_user_existence_errors = "ENABLED" # LEGACY or ENABLED (AWSの推奨はENABLED)
  generate_secret               = true      # アプリケーションシークレットの生成
  # アプリクライアントの設定
  supported_identity_providers         = ["COGNITO"]
  callback_urls                        = ["https://${local.name}.${local.domain_name}/oauth2/idpresponse"]
  allowed_oauth_flows                  = ["code"]
  allowed_oauth_flows_user_pool_client = true
  allowed_oauth_scopes = [
    "openid"
  ]
  explicit_auth_flows = [
    "ALLOW_CUSTOM_AUTH",
    "ALLOW_REFRESH_TOKEN_AUTH",
    "ALLOW_USER_SRP_AUTH",
  ]
}
resource "aws_cognito_user_pool_domain" "this" {
  domain       = local.cognito_oauth_domain_name
  user_pool_id = aws_cognito_user_pool.this.id
}</code></pre><h3 id=ネットワーク>ネットワーク</h3><p>ネットワークの設定は、<code>terraform-aws-modules/vpc/aws</code>を使って設定しています。</p><p><code>network.tf</code></p><pre><code class=language-json>module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "2.33.0"
  create_vpc = true
  name = local.name
  cidr            = local.cidr
  azs             = local.azs
  private_subnets = local.private_subnets
  public_subnets  = local.public_subnets
  enable_nat_gateway = true
  single_nat_gateway = true
  tags = local.tags
}</code></pre><h3 id=ロードバランサー>ロードバランサー</h3><p>Application Load Balancerの設定です。</p><ul><li>HTTPのリダイレクト設定</li><li>Cognito認証通したら固定レスポンスを返す</li></ul><p>などの設定をしています。</p><p><code>load-balancer.tf</code></p><pre><code class=language-json>module "alb" {
  source  = "terraform-aws-modules/alb/aws"
  version = "5.3.0"
  name = local.name
  vpc_id          = module.vpc.vpc_id
  subnets         = module.vpc.public_subnets
  security_groups = flatten([module.alb_https_sg.this_security_group_id, module.alb_http_sg.this_security_group_id])
  access_logs = {}
  https_listeners = [
    {
      port            = 443
      certificate_arn = local.certificate_arn
    },
  ]
  http_tcp_listeners = [
    {
      port     = 80
      protocol = "HTTP"
    },
  ]
  target_groups = [
    {
      name                 = local.name
      backend_protocol     = "HTTP"
      backend_port         = local.backend_port
      target_type          = "ip"
      deregistration_delay = 10
    },
  ]
  tags = local.tags
}
resource "aws_alb_listener_rule" "haribote_response" {
  listener_arn = module.alb.https_listener_arns[0]
  action {
    order = 1
    type  = "authenticate-cognito"
    authenticate_cognito {
      user_pool_arn       = aws_cognito_user_pool.this.arn
      user_pool_client_id = aws_cognito_user_pool_client.this.id
      user_pool_domain    = aws_cognito_user_pool_domain.this.domain
    }
  }
  action {
    order = 2
    type  = "fixed-response"
    fixed_response {
      content_type = "text/html"
      message_body = "&lt;h1&gt;Success&lt;/h1&gt;"
      status_code  = "200"
    }
  }
  condition {
    field  = "path-pattern"
    values = ["*"]
  }
}
resource "aws_lb_listener_rule" "redirect_http_to_https" {
  listener_arn = module.alb.http_tcp_listener_arns[0]
  action {
    type = "redirect"
    redirect {
      port        = "443"
      protocol    = "HTTPS"
      status_code = "HTTP_301"
    }
  }
  condition {
    field  = "path-pattern"
    values = ["*"]
  }
}
###################
# Security groups
###################
module "alb_https_sg" {
  source  = "terraform-aws-modules/security-group/aws//modules/https-443"
  version = "v3.0.1"
  name        = "${local.name}-alb-https"
  vpc_id      = module.vpc.vpc_id
  ingress_cidr_blocks = local.alb_ingress_cidr_blocks
  tags = local.tags
}
module "alb_http_sg" {
  source  = "terraform-aws-modules/security-group/aws//modules/http-80"
  version = "v3.0.1"
  name        = "${local.name}-alb-http"
  vpc_id      = module.vpc.vpc_id
  ingress_cidr_blocks = local.alb_ingress_cidr_blocks
  tags = local.tags
}
###################
# Route53 record
###################
data "aws_route53_zone" "this" {
  name         = local.domain_name
  private_zone = false
}
resource "aws_route53_record" "this" {
  zone_id = data.aws_route53_zone.this.zone_id
  name    = local.name
  type    = "A"
  alias {
    name                   = module.alb.this_lb_dns_name
    zone_id                = module.alb.this_lb_zone_id
    evaluate_target_health = true
  }
}</code></pre><h3 id=実行>実行</h3><p><code>terraform apply</code>すれば、各種リソースが作成されます。</p><h3 id=ユーザーの作成>ユーザーの作成</h3><p>認証に使用するユーザーを登録します。</p><ul><li><a href="https://ap-northeast-1.console.aws.amazon.com/cognito/users/?region=ap-northeast-1#/">ユーザープール コンソール</a> にアクセス<ul><li>Terraformで作成されたユーザープールを選択</li><li>左のリストから<code>ユーザーとプール</code>を選択</li><li>ユーザーの作成</li></ul></li></ul><h3 id=検証>検証</h3><p><code>https://cognito-test.example.com</code>にアクセスすると、認証画面が表示されます。( *<code>example.com</code>は自分のドメインに置換してください )</p><p>認証に成功して、<code>Success</code>という表示が出れば成功です。</p><h2 id=まとめ>まとめ</h2><p>Terraformを使って、AWS ALBにCognito認証をかけるサンプルコードでした。</p></article></div></div></div></main><footer class=footer><div class="ax-l-i max-w-6xl"><nav class="flex items-center justify-center"><a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/entry/>記事一覧</a>
<a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/about/>About</a>
<a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/contact/>Contact</a>
<a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/privacy-policy/>Privacy</a></nav><div class="footer-social flex items-center justify-center mt-4"><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=Twitter href=https://twitter.com/yutaka0m/><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11.0 01-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56.0 00-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57.0 002.914 5.452 6.48 6.48.0 01-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42.0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18.0 01-8.134 2.798c-.538.0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072.0 18.672-10 18.672-18.668.0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=Github href=https://github.com/yutaka0m/><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.998.0C7.164.0.0 7.35.0 16.417.0 23.67 4.584 29.82 10.944 31.994c.8.15 1.092-.356 1.092-.79l-.022-2.792c-4.45.99-5.4-2.202-5.4-2.202-.726-1.896-1.776-2.4-1.776-2.4-1.454-1.018.108-.998.108-.998 1.606.117 2.45 1.693 2.45 1.693 1.428 2.507 3.746 1.784 4.658 1.363.144-1.06.558-1.784 1.016-2.195-3.552-.415-7.288-1.823-7.288-8.113.0-1.792.624-3.258 1.648-4.406-.166-.415-.714-2.085.156-4.344.0.0 1.344-.44 4.4 1.683 1.276-.364 2.644-.546 4.006-.552a14.98 14.98.0 014.006.554C23.062 6.37 24.404 6.8 24.404 6.8c.872 2.26.324 3.93.16 4.344 1.026 1.148 1.644 2.614 1.644 4.406.0 6.306-3.74 7.694-7.304 8.1.574.507 1.086 1.51 1.086 3.04l-.02 4.503c0 .44.288.95 1.1.788C27.42 29.817 32 23.667 32 16.417 32 7.35 24.836.0 15.998.0z"/></svg></a></div><div class="footer-copyright text-sm text-center text-gray-500 mt-4">&#169; 2020-2021 yutaka0m blog</div><div class="text-sm sm:text-xs text-center text-gray-500 mt-2">Powered by <a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral">Axiom</a></div></div></footer><script src="/bundle.js?v=1613305652"></script></body></html>
<!doctype html><html lang=jp-ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=hugo-theme content="Axiom 0.7.0"><link rel=icon href=/image/favicon/favicon.ico><link rel=apple-touch-icon href=/image/brand/icon-1-1.jpg><link rel=canonical href=https://tech.yutaka0m.com/entry/2020/01/30/16/><link rel=preload as=style href="/bundle.css?v=1613305822" media=all><link rel=stylesheet href="/bundle.css?v=1613305822" media=all><style>.cdata pre{color:#edf2f7;background-color:#2d3748}.cdata :not(pre)>code{color:#805ad5;background-color:#f7fafc}.chroma .err{color:#fed7d7;background-color:#9b2c2c}.chroma .hl{background-color:#4a5568}.chroma .ln{color:#a0aec0}.chroma .k,.chroma .kc,.chroma .kd,.chroma .kn,.chroma .kp,.chroma .kr{color:#63b3ed}.chroma .kt{color:#b794f4}.chroma .na{color:#f6e05e}.chroma .nb{color:#f6ad55}.chroma .nc{color:#fc8181}.chroma .no{color:#68d391}.chroma .nd{color:#fc8181}.chroma .ne{color:#fc8181}.chroma .nf{color:#f6ad55}.chroma .nt{color:#fc8181}.chroma .l{color:#b794f4}.chroma .dl,.chroma .ld,.chroma .s,.chroma .s2,.chroma .sa,.chroma .sb,.chroma .sc,.chroma .sd{color:#68d391}.chroma .se{color:#a0aec0}.chroma .s1,.chroma .sh,.chroma .si,.chroma .sr,.chroma .ss,.chroma .sx{color:#68d391}.chroma .il,.chroma .m,.chroma .mb,.chroma .mf,.chroma .mh,.chroma .mi,.chroma .mo{color:#b794f4}.chroma .o,.chroma .ow{color:#90cdf4}.chroma .p{color:#cbd5e0}.chroma .c,.chroma .c1,.chroma .ch,.chroma .cm,.chroma .cp,.chroma .cpf,.chroma .cs{color:#a0aec0}.chroma .ge{font-style:italic}.chroma .gs{font-weight:700}</style><title>OpenAPI Generatorへのコントリビュート : yutaka0m blog</title><meta property="og:title" content="OpenAPI Generatorへのコントリビュート"><meta property="og:site_name" content="yutaka0m blog"><meta property="og:url" content="https://tech.yutaka0m.com/entry/2020/01/30/16/"><link rel=image_src href=https://tech.yutaka0m.com/image/top-image.jpg><meta property="og:image" content="https://tech.yutaka0m.com/image/top-image.jpg"><meta property="og:image:width" content="1920"><meta property="og:image:height" content="1080"><meta property="og:type" content="article"><meta property="og:locale" content="jp_ja"><meta property="og:description" content="初めに 先日、OSSであるOpenAPI GeneratorへPRを出して、マージされました。 Add deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub このPRについて、コミットを追いながら自分なりに解説します。 「*OpenAPI Generatorとは？」については、以下の資料が参考になります。  APIのコードを自動生成させたいだけならgRPCでなくてもよくない? – エムスリーテックブログ Swagger ではない OpenAPI Specification 3.0 による API サーバー開発  PRの内容 OpenAPIで以下のように、customerFirstNameがdeprecatedであると宣言します。 components: schemas: Request: type: object properties: customerCode: type: string example: �0001� customerFirstName: type: string example: �first� deprecated: true このYAMLを元に「OpenAPI Generatorでkotlin-springのテンプレートを指定して自動生成したときに、@Deprecated(message=“”)を挿入してくれるようにしたい。」という内容です。"><meta name=description content="初めに 先日、OSSであるOpenAPI GeneratorへPRを出して、マージされました。 Add deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub このPRについて、コミットを追いながら自分なりに解説します。 「*OpenAPI Generatorとは？」については、以下の資料が参考になります。  APIのコードを自動生成させたいだけならgRPCでなくてもよくない? – エムスリーテックブログ Swagger ではない OpenAPI Specification 3.0 による API サーバー開発  PRの内容 OpenAPIで以下のように、customerFirstNameがdeprecatedであると宣言します。 components: schemas: Request: type: object properties: customerCode: type: string example: �0001� customerFirstName: type: string example: �first� deprecated: true このYAMLを元に「OpenAPI Generatorでkotlin-springのテンプレートを指定して自動生成したときに、@Deprecated(message=“”)を挿入してくれるようにしたい。」という内容です。"><meta property="og:updated_time" content="2020-01-30T07:39:25Z"><meta property="fb:app_id" content><meta name=author content="yutaka0m"><meta property="article:author" content="https://tech.yutaka0m.com"><meta property="article:published_time" content="2020-01-30T07:39:25Z"><meta property="article:modified_time" content="2020-01-30T07:39:25Z"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"OpenAPI Generatorへのコントリビュート","alternativeHeadline":"初めに 先日、OSSであるOpenAPI GeneratorへPRを出して、マージされました。 Add deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub このPRについて、コミットを追いながら自分なりに解説します。 「*OpenAPI Generatorとは？」については、以下の資料が参考になります。  APIのコードを自動生成させたいだけならgRPCでなくてもよくない? – エムスリーテックブログ Swagger ではない OpenAPI Specification 3.0 による API サーバー開発  PRの内容 OpenAPIで以下のように、customerFirstNameがdeprecatedであると宣言します。 components: schemas: Request: type: object properties: customerCode: type: string example: �0001� customerFirstName: type: string example: �first� deprecated: true このYAMLを元に「OpenAPI Generatorでkotlin-springのテンプレートを指定して自動生成したときに、@Deprecated(message=“”)を挿入してくれるようにしたい。」という内容です。","url":"https://tech.yutaka0m.com/entry/2020/01/30/16/","image":"https://tech.yutaka0m.com/image/top-image.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://tech.yutaka0m.com/entry/2020/01/30/16/"},"description":"初めに 先日、OSSであるOpenAPI GeneratorへPRを出して、マージされました。 Add deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub このPRについて、コミットを追いながら自分なりに解説します。 「*OpenAPI Generatorとは？」については、以下の資料が参考になります。  APIのコードを自動生成させたいだけならgRPCでなくてもよくない? – エムスリーテックブログ Swagger ではない OpenAPI Specification 3.0 による API サーバー開発  PRの内容 OpenAPIで以下のように、customerFirstNameがdeprecatedであると宣言します。 components: schemas: Request: type: object properties: customerCode: type: string example: �0001� customerFirstName: type: string example: �first� deprecated: true このYAMLを元に「OpenAPI Generatorでkotlin-springのテンプレートを指定して自動生成したときに、@Deprecated(message=“”)を挿入してくれるようにしたい。」という内容です。","author":{"@type":"Person","name":"yutaka0m"},"publisher":{"@type":"Organization","name":"yutaka0m blog","logo":{"@type":"ImageObject","url":"https://tech.yutaka0m.com/image/brand/icon-1-1.jpg"}},"datePublished":"2020-01-30T07:39:25Z","dateModified":"2020-01-30T07:39:25Z","articleBody":"\u003ch2 id=\"初めに\"\u003e初めに\u003c/h2\u003e\n\u003cp\u003e先日、OSSであるOpenAPI GeneratorへPRを出して、マージされました。\u003c/p\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/OpenAPITools/openapi-generator/pull/5090\"\u003eAdd deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eこのPRについて、コミットを追いながら自分なりに解説します。\u003c/p\u003e\n\u003cp\u003e「*OpenAPI Generatorとは？」については、以下の資料が参考になります。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.m3tech.blog/entry/2019/08/15/110000\"\u003eAPIのコードを自動生成させたいだけならgRPCでなくてもよくない? – エムスリーテックブログ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.slideshare.net/techblogyahoo/swagger-openapi-specification-30-api\"\u003eSwagger ではない OpenAPI Specification 3.0 による API サーバー開発\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"prの内容\"\u003ePRの内容\u003c/h2\u003e\n\u003cp\u003eOpenAPIで以下のように、\u003ccode\u003ecustomerFirstName\u003c/code\u003eが\u003ccode\u003edeprecated\u003c/code\u003eであると宣言します。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003ecomponents:\n  schemas:\n    Request:\n      type: object\n      properties:\n        customerCode:\n          type: string\n          example: \u0026#039;0001\u0026#039;\n        customerFirstName:\n          type: string\n          example: \u0026#039;first\u0026#039;\n          deprecated: true\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eこのYAMLを元に「OpenAPI Generatorで\u003ccode\u003ekotlin-spring\u003c/code\u003eのテンプレートを指定して自動生成したときに、\u003ccode\u003e@Deprecated(message=“”)\u003c/code\u003eを挿入してくれるようにしたい。」という内容です。\u003c/p\u003e\n\u003cp\u003e以下が、理想とする出力結果です。PR前は、OpenAPIで\u003ccode\u003edeprecated: true\u003c/code\u003eと宣言しても、自動生成されたコードには何も反映されていませんでした。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-kotlin\"\u003edata class Response (\n    @JsonProperty(“customerCode”) val customerCode: kotlin.String? = null,\n    @Deprecated(message=“”)\n    @JsonProperty(“customerFirstName”) val customerFirstName: kotlin.String? = null\n)\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"コミットを追っていく\"\u003eコミットを追っていく\u003c/h2\u003e\n\u003cp\u003e以下、PRのコミットログを1つ1つ追っていきます。\u003c/p\u003e\n\u003ch3 id=\"add-deprecated-in-kotlin-dataclass\"\u003eadd Deprecated in kotlin dataClass\u003c/h3\u003e\n\u003cp\u003eCommit -\u0026gt; \u003ca href=\"https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/b3c9bc394da7d6ee6127c46974afa7da58be6b72\"\u003eAdd deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eOpenAPI Generatorのgenerateコマンドを実行すると、codegen配下のjavaがOpenAPIを読み込んだ後、mustacheのテンプレートエンジンへバインドするようになっています。\u003c/p\u003e\n\u003cp\u003e今回は対象のテンプレートが\u003ccode\u003ekotlin-spring\u003c/code\u003eなので、\u003ca href=\"https://github.com/OpenAPITools/openapi-generator/tree/master/modules/openapi-generator/src/main/resources/kotlin-spring\"\u003eresources/kotlin-spring\u003c/a\u003e配下が対象のテンプレートです。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e@Deprecated\u003c/code\u003eのアノテーションをつけたいのは\u003ccode\u003edata class\u003c/code\u003eなので\u003ca href=\"https://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator/src/main/resources/kotlin-spring/dataClass.mustache\"\u003edataClass.mustache\u003c/a\u003eを見ます。\u003c/p\u003e\n\u003cp\u003eまずはmustacheを頑張って読み解きます。（※mustacheは可読性が低い）\u003c/p\u003e\n\u003cp\u003e下記は、dataClass.mustacheの一部ですが、なんとなくkotlinの\u003ccode\u003edata class\u003c/code\u003eに見えてきます。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e# — 省略 —\ndata class {{classname}} (\n{{#requiredVars}}\n{{\u0026gt;dataClassReqVar}}{{^-last}},\n{{/-last}}{{/requiredVars}}{{#hasRequired}}{{#hasOptional}},\n{{/hasOptional}}{{/hasRequired}}{{#optionalVars}}{{\u0026gt;dataClassOptVar}}{{^-last}},\n{{/-last}}{{/optionalVars}}\n)\n# — 省略 —\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eなんとなく以下のように見えませんか？\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-kotlin\"\u003edata class Hoge (\n) \u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e人間にわかるように解読すると以下のようになります。\u003cbr\u003e\n（if文の開始と終了は\u003ccode\u003eif\u003c/code\u003e , \u003ccode\u003efi\u003c/code\u003eで示しました）\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e# — 省略 —\ndata class {{クラス名}} (\n{{requiredVarsリストの繰り返し:開始}}\n{{dataClassReqVar.mustacheを挿入する}}{{if not リストの最後}},\n{{fi not リストの最後}}{{/requiredVarsリストの繰り返し:終了}}{{if hasRequired == true \u0026\u0026 if hasOptional == true}},\n{{fi hasRequired == true \u0026\u0026 if hasOptional == true}}{{optionalVarsの繰り返し:開始}}{{dataClassOptVar.mustacheを挿入する}}{{if not リストの最後}},\n{{fi not リストの最後}}{{optionalVarsの繰り返し:終了}}\n)\n# — 省略 —\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eメインの繰り返し処理だけ抜き出すと\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003erequiredVars（必須パラメーター）のリストがある限り、dataClassReqVar.mustacheを挿入する\u003c/li\u003e\n\u003cli\u003eoptionalVars（非必須パラメーター）のリストがある限り、dataClassOptVar.mustacheを挿入する\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eやりたいことは、非必須パラメーターに\u003ccode\u003e@Deprecated\u003c/code\u003eのアノテーションをつけることなので、「\u003ca href=\"https://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator/src/main/resources/kotlin-spring/dataClassOptVar.mustache\"\u003edataClassOptVar.mustache\u003c/a\u003eを編集すれば良い」とわかりました。\u003c/p\u003e\n\u003cp\u003edataClassOptVar.mustacheを \u003ca href=\"https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/b3c9bc394da7d6ee6127c46974afa7da58be6b72\"\u003e修正\u003c/a\u003eし、以下を追加しました。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e# — 省略 —\n{{#deprecated}}\n    @Deprecated(message=“”){{/deprecated}}\n# — 省略 —\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eこちらも翻訳すると、\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e# — 省略 —\n{{#if deprecated == true}}\n    @Deprecated(message=“”){{fi deprecated == true}}\n# — 省略 —\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003edeprecated\u003c/code\u003eなら改行して、\u003ccode\u003e@Deprecated(message=“”)\u003c/code\u003eを挿入する。と宣言しています。\u003c/p\u003e\n\u003ch3 id=\"add-deprecated-in-codegenproperty\"\u003eadd deprecated in CodegenProperty\u003c/h3\u003e\n\u003cp\u003eCommit -\u0026gt; \u003ca href=\"https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/73e2ef348bc9fca2dda632b70e5507d9746c8a99\"\u003eAdd deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eテンプレートの修正が終わったので、\u003ca href=\"https://github.com/OpenAPITools/openapi-generator/tree/master/modules/openapi-generator/src/main/java/org/openapitools/codegen\"\u003ecodegen\u003c/a\u003e側の修正をします。\u003c/p\u003e\n\u003cp\u003e今回追加するのは、OpenAPIでいうと\u003ccode\u003eproperties\u003c/code\u003e配下の\u003ccode\u003edeprecated\u003c/code\u003eです。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003eproperties:\n  customerCode:\n    type: string\n    example: ‘0001’\n  customerFirstName:\n    type: string\n    example: ‘first’\n    # ↓を拾いたい\n    deprecated: true\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003eproperties\u003c/code\u003eで宣言した値は、\u003ca href=\"https://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator/src/main/java/org/openapitools/codegen/CodegenProperty.java\"\u003eCodegenProperty.java\u003c/a\u003eで保持しています。\u003c/p\u003e\n\u003cp\u003edeprecatedをboolean値として宣言し、テンプレートに追加して欲しいので、以下を追記しました。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic boolean deprecated;\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eさらに、そのほかの関数と同じように\u003ccode\u003epublic boolean equals\u003c/code\u003eと\u003ccode\u003epublic int hashCode()\u003c/code\u003eに\u003ccode\u003edeprecated\u003c/code\u003eを追加しておきます。\u003c/p\u003e\n\u003ch3 id=\"format-column-limit-100\"\u003eformat (Column limit: 100)\u003c/h3\u003e\n\u003cp\u003eCommit -\u0026gt; \u003ca href=\"https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/663606ab9fc8570c665bea4d6daeb74cd21ccbf3\"\u003ehttps://github.com/OpenAPITools/openapi-generator/pull/5090/commits/663606ab9fc8570c665bea4d6daeb74cd21ccbf3\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e修正の結果、行が長くなったのでフォーマットをかけました。\u003c/p\u003e\n\u003cp\u003e変更箇所が分かりにくくなるので、1つ前のコミットとはあえて分けました。\u003c/p\u003e\n\u003ch3 id=\"set-propertydeprecated\"\u003eset property.deprecated\u003c/h3\u003e\n\u003cp\u003ecommit -\u0026gt; \u003ca href=\"https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/4ea8d3920057a7213e06c1dae1b04414cbf24ec9\"\u003ehttps://github.com/OpenAPITools/openapi-generator/pull/5090/commits/4ea8d3920057a7213e06c1dae1b04414cbf24ec9\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator/src/main/java/org/openapitools/codegen/CodegenProperty.java\"\u003eCodegenProperty.java\u003c/a\u003eに\u003ccode\u003edeprecated\u003c/code\u003eを追加しましたが、\u003ccode\u003eCodegenProperty\u003c/code\u003eのインスタンス生成時に\u003ccode\u003edeprecated\u003c/code\u003eへ値を挿入するコードを書いていないので、今は常にnullになります。\u003c/p\u003e\n\u003cp\u003eそこで、\u003ca href=\"https://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator/src/main/java/org/openapitools/codegen/DefaultCodegen.java\"\u003eDefaultCodegen.java\u003c/a\u003e に追記します。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic CodegenProperty fromProperty(String name, Schema p) {\n// 省略…\n    CodegenProperty property = CodegenModelFactory.newInstance(CodegenModelType.PROPERTY);\n// 以下を追記\n    if (p.getDeprecated() != null) {\n        property.deprecated = p.getDeprecated();\n    }\n// …\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOpenAPIのYAMLをマッピングした結果が\u003ccode\u003eSchema p\u003c/code\u003eに入っているので、その値を\u003ccode\u003eCodegenProperty\u003c/code\u003eの\u003ccode\u003edeprecated\u003c/code\u003eに代入します。\u003c/p\u003e\n\u003cp\u003e（\u003cstrong\u003eNullPointerException\u003c/strong\u003eになるので、先にnullチェックをするのを忘れずに）\u003c/p\u003e\n\u003ch3 id=\"add-test\"\u003eadd test\u003c/h3\u003e\n\u003cp\u003eCommit -\u0026gt; \u003ca href=\"https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/1463af52ee148fef67d1f8ab5b23be6847dc89e1\"\u003eAdd deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e実装は終わったので、テストを追記します。\u003c/p\u003e\n\u003cp\u003eテストするためのOpenAPIのYAMLファイルがない場合は、好きに作成してOKです。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003etestDeprecatedProperty\u003c/code\u003eは\u003ccode\u003eCodegenProperty\u003c/code\u003eに\u003ccode\u003edeprecated\u003c/code\u003eが正しく渡っているかをテストしています。\u003c/p\u003e\n\u003ch3 id=\"run-binkotlin-springboot-petstore-allsh\"\u003erun ./bin/kotlin-springboot-petstore-all.sh\u003c/h3\u003e\n\u003cp\u003eCommit -\u0026gt; \u003ca href=\"https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/5adbdcdf89b9d50069741b97c0347f7c8ce8e3a2\"\u003eAdd deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003ePRを出す準備です。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/OpenAPITools/openapi-generator/blob/master/.github/PULL_REQUEST_TEMPLATE.md\"\u003ePR checklist\u003c/a\u003eに記述されているように、\u003ccode\u003e./bin/{LANG}-petstore.sh\u003c/code\u003eを実行してコミットします。\u003c/p\u003e\n\u003ch2 id=\"その他\"\u003eその他\u003c/h2\u003e\n\u003cp\u003e以上、ざっとですがPRのコミットログをたどっていきました。少しでも参考になれば幸いです。\u003c/p\u003e"}</script><link rel=preload as=script href="/bundle.js?v=1613305822"></head><body><header id=nav class=header><div class="ax-l-i max-w-6xl"><div class=ax-logo><a class=block href=/ title="yutaka0m blog"><span class="font-semibold text-raven-900">yutaka0m blog</span></a></div><div class=ax-user><a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target=_blank rel="noopener nofollow" href="https://www.google.com/search?q=site:https://tech.yutaka0m.com" title=Search><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33.0 002.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg></a><a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href=/entry/>記事一覧</a></div></div></header><main><div class=default-single><div class="ax-title ax-l-o"><div class="ax-l-i max-w-680"><h1 class="post-title font-content-title font-normal leading-tight tracking-default text-40">OpenAPI Generatorへのコントリビュート</h1><div class="ax-meta flex items-center mt-5"><div class="flex-grow min-w-0"><div class="flex items-center"><div class=flex-shrink-0><img class="w-12 h-12 sm:w-14 sm:h-14 object-cover p-3px rounded-full border border-blue-300" src=/image/author/default.jpg alt=yutaka0m></div><div class="flex-shrink-0 ml-2 leading-tight font-content-sans"><a class="block text-sm text-raven-800 hover:text-raven-900 hover:underline focus:underline" target=_blank rel="noopener nofollow" title=yutaka0m href=https://tech.yutaka0m.com>yutaka0m</a>
<time class="text-sm text-raven-500" datetime=2020-01-30T07:39:25Z>Jan 30, 2020 7:39AM</time></div></div></div><div><div class="flex items-center"><a class="flex-shrink-0 block text-raven-800 hover:text-raven-900" target=_blank rel="noopener nofollow" title="Share on Twitter" href="https://twitter.com/intent/tweet?text=OpenAPI%20Generator%e3%81%b8%e3%81%ae%e3%82%b3%e3%83%b3%e3%83%88%e3%83%aa%e3%83%93%e3%83%a5%e3%83%bc%e3%83%88%20by%20%40yutaka0m%20https%3a%2f%2ftech.yutaka0m.com%2fentry%2f2020%2f01%2f30%2f16%2f"><svg class="w-6 h-6 fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11.0 01-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56.0 00-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57.0 002.914 5.452 6.48 6.48.0 01-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42.0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18.0 01-8.134 2.798c-.538.0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072.0 18.672-10 18.672-18.668.0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a><a class="ml-3 flex-shrink-0 block text-raven-800 hover:text-raven-900" target=_blank rel="noopener nofollow" title="Share on Facebook" href="https://www.facebook.com/dialog/share?app_id=&display=page&href=https%3a%2f%2ftech.yutaka0m.com%2fentry%2f2020%2f01%2f30%2f16%2f"><svg class="w-6 h-6 fill-current" viewBox="-7 -3.5 39 39" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.234.0H1.765C.8.001.0.79.0 1.766v28.47C.001 31.2.79 32 1.766 32h15.328V19.625h-4.156V14.78h4.156v-3.564c0-4.134 2.523-6.384 6.21-6.384 1.766.0 3.284.13 3.726.2v4.32h-2.543c-2.006.0-2.394.953-2.394 2.352v3.085h4.797l-.625 4.844h-4.172V32h8.14C31.21 32 32 31.2 32 30.234V1.765C32 .8 31.21.0 30.234.0z"/></svg></a></div></div></div></div></div><div class="ax-content ax-l-o"><div class="ax-l-i max-w-680"><article class=cdata><h2 id=初めに>初めに</h2><p>先日、OSSであるOpenAPI GeneratorへPRを出して、マージされました。</p></p><p><a href=https://github.com/OpenAPITools/openapi-generator/pull/5090>Add deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub</a></p><p>このPRについて、コミットを追いながら自分なりに解説します。</p><p>「*OpenAPI Generatorとは？」については、以下の資料が参考になります。</p><ul><li><a href=https://www.m3tech.blog/entry/2019/08/15/110000>APIのコードを自動生成させたいだけならgRPCでなくてもよくない? – エムスリーテックブログ</a></li><li><a href=https://www.slideshare.net/techblogyahoo/swagger-openapi-specification-30-api>Swagger ではない OpenAPI Specification 3.0 による API サーバー開発</a></li></ul><h2 id=prの内容>PRの内容</h2><p>OpenAPIで以下のように、<code>customerFirstName</code>が<code>deprecated</code>であると宣言します。</p><pre><code class=language-yaml>components:
  schemas:
    Request:
      type: object
      properties:
        customerCode:
          type: string
          example: &#039;0001&#039;
        customerFirstName:
          type: string
          example: &#039;first&#039;
          deprecated: true</code></pre><p>このYAMLを元に「OpenAPI Generatorで<code>kotlin-spring</code>のテンプレートを指定して自動生成したときに、<code>@Deprecated(message=“”)</code>を挿入してくれるようにしたい。」という内容です。</p><p>以下が、理想とする出力結果です。PR前は、OpenAPIで<code>deprecated: true</code>と宣言しても、自動生成されたコードには何も反映されていませんでした。</p><pre><code class=language-kotlin>data class Response (
    @JsonProperty(“customerCode”) val customerCode: kotlin.String? = null,
    @Deprecated(message=“”)
    @JsonProperty(“customerFirstName”) val customerFirstName: kotlin.String? = null
)</code></pre><h2 id=コミットを追っていく>コミットを追っていく</h2><p>以下、PRのコミットログを1つ1つ追っていきます。</p><h3 id=add-deprecated-in-kotlin-dataclass>add Deprecated in kotlin dataClass</h3><p>Commit -> <a href=https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/b3c9bc394da7d6ee6127c46974afa7da58be6b72>Add deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub</a></p><p>OpenAPI Generatorのgenerateコマンドを実行すると、codegen配下のjavaがOpenAPIを読み込んだ後、mustacheのテンプレートエンジンへバインドするようになっています。</p><p>今回は対象のテンプレートが<code>kotlin-spring</code>なので、<a href=https://github.com/OpenAPITools/openapi-generator/tree/master/modules/openapi-generator/src/main/resources/kotlin-spring>resources/kotlin-spring</a>配下が対象のテンプレートです。</p><p><code>@Deprecated</code>のアノテーションをつけたいのは<code>data class</code>なので<a href=https://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator/src/main/resources/kotlin-spring/dataClass.mustache>dataClass.mustache</a>を見ます。</p><p>まずはmustacheを頑張って読み解きます。（※mustacheは可読性が低い）</p><p>下記は、dataClass.mustacheの一部ですが、なんとなくkotlinの<code>data class</code>に見えてきます。</p><pre><code class=language-bash># — 省略 —
data class {{classname}} (
{{#requiredVars}}
{{&gt;dataClassReqVar}}{{^-last}},
{{/-last}}{{/requiredVars}}{{#hasRequired}}{{#hasOptional}},
{{/hasOptional}}{{/hasRequired}}{{#optionalVars}}{{&gt;dataClassOptVar}}{{^-last}},
{{/-last}}{{/optionalVars}}
)
# — 省略 —</code></pre><p>なんとなく以下のように見えませんか？</p><pre><code class=language-kotlin>data class Hoge (
) </code></pre><p>人間にわかるように解読すると以下のようになります。<br>（if文の開始と終了は<code>if</code> , <code>fi</code>で示しました）</p><pre><code class=language-bash># — 省略 —
data class {{クラス名}} (
{{requiredVarsリストの繰り返し:開始}}
{{dataClassReqVar.mustacheを挿入する}}{{if not リストの最後}},
{{fi not リストの最後}}{{/requiredVarsリストの繰り返し:終了}}{{if hasRequired == true && if hasOptional == true}},
{{fi hasRequired == true && if hasOptional == true}}{{optionalVarsの繰り返し:開始}}{{dataClassOptVar.mustacheを挿入する}}{{if not リストの最後}},
{{fi not リストの最後}}{{optionalVarsの繰り返し:終了}}
)
# — 省略 —</code></pre><p>メインの繰り返し処理だけ抜き出すと</p><ol><li>requiredVars（必須パラメーター）のリストがある限り、dataClassReqVar.mustacheを挿入する</li><li>optionalVars（非必須パラメーター）のリストがある限り、dataClassOptVar.mustacheを挿入する</li></ol><p>やりたいことは、非必須パラメーターに<code>@Deprecated</code>のアノテーションをつけることなので、「<a href=https://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator/src/main/resources/kotlin-spring/dataClassOptVar.mustache>dataClassOptVar.mustache</a>を編集すれば良い」とわかりました。</p><p>dataClassOptVar.mustacheを <a href=https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/b3c9bc394da7d6ee6127c46974afa7da58be6b72>修正</a>し、以下を追加しました。</p><pre><code class=language-bash># — 省略 —
{{#deprecated}}
    @Deprecated(message=“”){{/deprecated}}
# — 省略 —</code></pre><p>こちらも翻訳すると、</p><pre><code class=language-bash># — 省略 —
{{#if deprecated == true}}
    @Deprecated(message=“”){{fi deprecated == true}}
# — 省略 —</code></pre><p><code>deprecated</code>なら改行して、<code>@Deprecated(message=“”)</code>を挿入する。と宣言しています。</p><h3 id=add-deprecated-in-codegenproperty>add deprecated in CodegenProperty</h3><p>Commit -> <a href=https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/73e2ef348bc9fca2dda632b70e5507d9746c8a99>Add deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub</a></p><p>テンプレートの修正が終わったので、<a href=https://github.com/OpenAPITools/openapi-generator/tree/master/modules/openapi-generator/src/main/java/org/openapitools/codegen>codegen</a>側の修正をします。</p><p>今回追加するのは、OpenAPIでいうと<code>properties</code>配下の<code>deprecated</code>です。</p><pre><code class=language-yaml>properties:
  customerCode:
    type: string
    example: ‘0001’
  customerFirstName:
    type: string
    example: ‘first’
    # ↓を拾いたい
    deprecated: true</code></pre><p><code>properties</code>で宣言した値は、<a href=https://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator/src/main/java/org/openapitools/codegen/CodegenProperty.java>CodegenProperty.java</a>で保持しています。</p><p>deprecatedをboolean値として宣言し、テンプレートに追加して欲しいので、以下を追記しました。</p><pre><code class=language-java>public boolean deprecated;</code></pre><p>さらに、そのほかの関数と同じように<code>public boolean equals</code>と<code>public int hashCode()</code>に<code>deprecated</code>を追加しておきます。</p><h3 id=format-column-limit-100>format (Column limit: 100)</h3><p>Commit -> <a href=https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/663606ab9fc8570c665bea4d6daeb74cd21ccbf3>https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/663606ab9fc8570c665bea4d6daeb74cd21ccbf3</a></p><p>修正の結果、行が長くなったのでフォーマットをかけました。</p><p>変更箇所が分かりにくくなるので、1つ前のコミットとはあえて分けました。</p><h3 id=set-propertydeprecated>set property.deprecated</h3><p>commit -> <a href=https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/4ea8d3920057a7213e06c1dae1b04414cbf24ec9>https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/4ea8d3920057a7213e06c1dae1b04414cbf24ec9</a></p><p><a href=https://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator/src/main/java/org/openapitools/codegen/CodegenProperty.java>CodegenProperty.java</a>に<code>deprecated</code>を追加しましたが、<code>CodegenProperty</code>のインスタンス生成時に<code>deprecated</code>へ値を挿入するコードを書いていないので、今は常にnullになります。</p><p>そこで、<a href=https://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator/src/main/java/org/openapitools/codegen/DefaultCodegen.java>DefaultCodegen.java</a> に追記します。</p><pre><code class=language-java>public CodegenProperty fromProperty(String name, Schema p) {
// 省略…
    CodegenProperty property = CodegenModelFactory.newInstance(CodegenModelType.PROPERTY);
// 以下を追記
    if (p.getDeprecated() != null) {
        property.deprecated = p.getDeprecated();
    }
// …</code></pre><p>OpenAPIのYAMLをマッピングした結果が<code>Schema p</code>に入っているので、その値を<code>CodegenProperty</code>の<code>deprecated</code>に代入します。</p><p>（<strong>NullPointerException</strong>になるので、先にnullチェックをするのを忘れずに）</p><h3 id=add-test>add test</h3><p>Commit -> <a href=https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/1463af52ee148fef67d1f8ab5b23be6847dc89e1>Add deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub</a></p><p>実装は終わったので、テストを追記します。</p><p>テストするためのOpenAPIのYAMLファイルがない場合は、好きに作成してOKです。</p><p><code>testDeprecatedProperty</code>は<code>CodegenProperty</code>に<code>deprecated</code>が正しく渡っているかをテストしています。</p><h3 id=run-binkotlin-springboot-petstore-allsh>run ./bin/kotlin-springboot-petstore-all.sh</h3><p>Commit -> <a href=https://github.com/OpenAPITools/openapi-generator/pull/5090/commits/5adbdcdf89b9d50069741b97c0347f7c8ce8e3a2>Add deprecated annotation in kotlin-spring by yutaka0m · Pull Request #5090 · OpenAPITools/openapi-generator · GitHub</a></p><p>PRを出す準備です。</p><p><a href=https://github.com/OpenAPITools/openapi-generator/blob/master/.github/PULL_REQUEST_TEMPLATE.md>PR checklist</a>に記述されているように、<code>./bin/{LANG}-petstore.sh</code>を実行してコミットします。</p><h2 id=その他>その他</h2><p>以上、ざっとですがPRのコミットログをたどっていきました。少しでも参考になれば幸いです。</p></article></div></div></div></main><footer class=footer><div class="ax-l-i max-w-6xl"><nav class="flex items-center justify-center"><a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/entry/>記事一覧</a>
<a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/about/>About</a>
<a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/contact/>Contact</a>
<a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/privacy-policy/>Privacy</a></nav><div class="footer-social flex items-center justify-center mt-4"><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=Twitter href=https://twitter.com/yutaka0m/><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11.0 01-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56.0 00-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57.0 002.914 5.452 6.48 6.48.0 01-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42.0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18.0 01-8.134 2.798c-.538.0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072.0 18.672-10 18.672-18.668.0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=Github href=https://github.com/yutaka0m/><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.998.0C7.164.0.0 7.35.0 16.417.0 23.67 4.584 29.82 10.944 31.994c.8.15 1.092-.356 1.092-.79l-.022-2.792c-4.45.99-5.4-2.202-5.4-2.202-.726-1.896-1.776-2.4-1.776-2.4-1.454-1.018.108-.998.108-.998 1.606.117 2.45 1.693 2.45 1.693 1.428 2.507 3.746 1.784 4.658 1.363.144-1.06.558-1.784 1.016-2.195-3.552-.415-7.288-1.823-7.288-8.113.0-1.792.624-3.258 1.648-4.406-.166-.415-.714-2.085.156-4.344.0.0 1.344-.44 4.4 1.683 1.276-.364 2.644-.546 4.006-.552a14.98 14.98.0 014.006.554C23.062 6.37 24.404 6.8 24.404 6.8c.872 2.26.324 3.93.16 4.344 1.026 1.148 1.644 2.614 1.644 4.406.0 6.306-3.74 7.694-7.304 8.1.574.507 1.086 1.51 1.086 3.04l-.02 4.503c0 .44.288.95 1.1.788C27.42 29.817 32 23.667 32 16.417 32 7.35 24.836.0 15.998.0z"/></svg></a></div><div class="footer-copyright text-sm text-center text-gray-500 mt-4">&#169; 2020-2021 yutaka0m blog</div><div class="text-sm sm:text-xs text-center text-gray-500 mt-2">Powered by <a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral">Axiom</a></div></div></footer><script src="/bundle.js?v=1613305822"></script></body></html>